<!doctype html>
<html lang="fr">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    
    <!-- font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <!--jQuery pour le datepicker et le select2-->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- Datatables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/jszip-2.5.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/b-print-2.2.3/date-1.1.2/sl-1.4.0/datatables.min.css"/>

    <style type="text/css">

        .btn-bm{
            color: #fff;
            background-color: #334A70;
            border-color: #334A70;
        }
        .btn-bm:hover {
            color: #334A70;
            background-color: #fff;
            border-color: #334A70;
        }
        .btn-rm{
            color: #fff;
            background-color: #910a13;
            border-color: #910a13;
        }
        .btn-rm:hover {
            color: #910a13;
            background-color: #fff;
            border-color: #910a13 ;
        }
        .btn-outline-rm {
            color: #910a13;
            background-color: #fff;
            border-color: #910a13;
        }
        .btn-outline-rm:hover {
            color: #fff;
            background-color: #910a13;
            border-color: #910a13;
        }
        .bg-rm{
            color: #fff;
            background-color: #910a13;
        }
        .btn-dt-bm{
            color: #334A70;
            background-color: transparent;
        }
        .btn-dt-bm:hover {
            color: #fff;
            background-color: #334A70;
        }
        .btn-dt-gm{
            color: #03940a;
            background-color: transparent;
        }
        .btn-dt-gm:hover {
            color: #fff;
            background-color: #03940a;
        }
        .btn-dt-rm{
            color: #910a13;
            background-color: transparent;
        }
        .btn-dt-rm:hover {
            color: #fff;
            background-color: #910a13;
        }
        .nav-link, .nav-link:visited, .nav-link:active{
            color:white;
        }
        .nav-link:hover{
            color:#B1B1B1;
        }
        nav a, nav a:link, nav a.dropdown-item{
            color:white;
        }
        nav a.dropdown-item:hover{
            color:#B1B1B1;
            background-color: #910a13;
        }
        a:hover{
            color: #B1B1B1;
        }
        button a, ul li a, a{
            color: #334A70;
            outline: none;
            text-decoration: none;
        }
        tr.odd{
            background-color: #f1f1f1;
        }
        tr.odd:hover, tr.even:hover {
            background-color: #B1B1B1;
            color:#fff;
        }
        h4 {
            text-transform: uppercase;
        }

    </style>

</head>
<div class="container my-3">
    <div class="row justify-content-end">
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-bm rounded-0 mt-2" id="ajouter" data-bs-toggle="modal"
                data-bs-target="#Modal" $displayAdd$>Ajouter un élément</button>
        </div>
    </div>
    <table id="maTable" class="table table-bordered nowrap" width="100%" height="100%">
        <thead>
            <tr id="entete">
            </tr>
        </thead>
    </table>


    <!-- Modal Edition Candidat -->
    <div class="modal fade xl vh-80" id="Modal" tabindex="-2"  data-bs-backdrop="static" aria-labelledby="ModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body " style="height: 70vh;">
                    <div class="mb-3" id="form_edit">
                        <!--Onglets de la modale-->
                        <nav>
                            <div class="nav nav-tabs nav-fill">
                                <a class="nav-link active text-primary fs-6 p-1" id="modifier_candidat" data-bs-toggle="tab" data-bs-target="#candidat-tab-pane" type="button">
                                    Candidat 
                                </a>
                                <a class="nav-link text-secondary fs-6 p-1" id="modifier_dossier" data-bs-toggle="tab" data-bs-target="#dossier-tab-pane" type="button">
                                    Informations dossier 
                                </a>
                                <a class="nav-link text-secondary fs-6 p-1" id="modifier_notes" data-bs-toggle="tab" data-bs-target="#notes-tab-pane" type="button">
                                    Notes 
                                </a>
                                <a class="nav-link text-secondary fs-6 p-1" id="modifier_coordonnees" data-bs-toggle="tab" data-bs-target="#coordonnees-tab-pane" type="button" >
                                    Coordonnées 
                                </a>
                                <a class="nav-link text-secondary fs-6 p-1" id="voir_evenements" data-bs-toggle="tab" data-bs-target="#evenements-tab-pane" type="button">Événements</a>
                            </div>
                        </nav>
                        <!--Contenu des onglets -->
                        <form action="#" method="post" class="p-1 tab-content">
                            <div class="tab-pane fade show active mt-3" id="candidat-tab-pane" role="tabpanel" aria-labelledby="modifier_candidat" tabindex="0">
                                <fieldset>
                                    <div class="row">
                                        <div class="col">
                                        <!--Nom-->
                                            <div class="form-floating">
                                                <input id="Nom" name="Nom" type="text" maxlength="100" class="form-control shadow-sm" placeholder="Doe">
                                                <label for="Nom" class="form-label">Nom</label>
                                            </div>
                                        </div>
                                        <div class="col">
                                        <!--Prenom-->
                                            <div class="form-floating mb-3">
                                                <input id="Prenom" type="text" maxlength="100" class="form-control shadow-sm" placeholder="John" name="Prenom">
                                                <label for="Prenom" class="form-label">Prénom</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!--Email-->
                                    <div class="form-floating mb-3">
                                        <input id="email" type="email" maxlength="100" class="form-control shadow-sm" placeholder="jdoe@example.mail" name="email">
                                        <label for="email" class="form-label">email</label>
                                    </div>
                                    <!--Date de Naissance-->
                                    <div class="form-floating mb-3">
                                        <input id="datenaissance" type="date" maxlength="100" class="form-control shadow-sm" placeholder="01/01/2000" name="datenaissance">
                                        <label for="datenaissance" class="form-label">Date de naissance</label>
                                    </div>
                                    <!--Sexe-->
                                    <div class="form-floating mb-3">
                                        <select name="Sexe" id="Sexe" class="form-select">
                                            <option selected>Choisir une option</option>
                                            <option value="M">Masculin</option>
                                            <option value="F">Feminin</option>
                                        </select>
                                        <label for="Sexe" class="form-label">Sexe</label>
                                    </div>
                                </fieldset>
                            </div>
                            <!--Informations du dossier-->
                            <div class="tab-pane fade  show mt-3" id="dossier-tab-pane" role="tabpanel" aria-labelledby="modifier_dossier" tabindex="0">
                                <fieldset>
                                    <div class="row">
                                        <div class="col-lg-7">
                                            <!--Numéro de dossier-->
                                            <div class="form-floating mb-3">
                                                <input id="NDossier" type="text" maxlength="100" class="form-control shadow-sm" placeholder="inconnu" name="NDossier">
                                                <label for="NDossier" class="form-label">Numéro de dossier</label>
                                            </div>
                                        </div>
                                        <div class="col-lg-5">                                   
                                            <!--Date de Creation-->
                                            <div class="form-floating mb-3">
                                                <input id="Creation" type="date" maxlength="100" class="form-control shadow-sm" placeholder="18/12/2022" name="Creation">
                                                <label for="Creation" class="form-label">Date de création</label>
                                            </div>                                   
                                       </div>
                                    </div>
                                    <!--Nom du centre-->
                                    <div class="form-floating mb-3">
                                        <select name="CentreNom" id="CentreNom" class="form-select">
                                            <option selected>Choisir une option</option>
                                            <option value="ESPI Paris">ESPI Paris</option> 
                                            <option value="ESPI Marseille">ESPI Marseille</option> 
                                            <option value="ESPI Lyon">ESPI Lyon</option>                                              
                                            <option value="ESPI Bordeaux">ESPI Bordeaux</option>
                                            <option value="ESPI Nantes">ESPI Nantes</option>
                                            <option value="ESPI Montreal">ESPI Montréal</option>
                                            <option value="ESPI Montpellier">ESPI Montpellier</option>
                                        </select>
                                        <label for="CentreNom" class="form-label">Centre</label>
                                    </div>
                                        <!--Formation souhaitée-->
                                        <div class="form-floating mb-3">
                                            <select name="FormationSouhaitee" id="FormationSouhaitee" class="form-select">
                                                <option selected>Choisir une option</option>
                                                <option value="GESAI 1 TP">GESAI 1 TP</option>
                                                <option value="GESAI 1 ALTERNANCE">GESAI 1 Alternance</option>
                                                <option value="GESAI 3 ALTERNANCE">GESAI 3 Alternance</option>
                                                <option value="M1 MAPI ALTERNANCE">M1 MAPI Alternance</option>
                                                <option value="M1 MIFIM ALTERNANCE">M1 MIFIM Alternance</option>
                                                <option value="M1 SPECIALITE INDETERMINEE - ALTERNANCE">M1 Spécialité indéterminée - Alternance</option>
                                            </select>
                                            <label for="FormationSouhaitee" class="form-label">Formation souhaitée</label>
                                        </div>
                                        <!--Statut ISO-->
                                        <div class="form-floating mb-3">
                                            <select name="ISOStatut" id="ISOStatut" class="form-select" name="ISOStatut">
                                                <option selected>Choisir une option</option>
                                                <option value="CANDIDAT">Candidat</option>
                                                <option value="PROSPECT">Prospect</option>
                                            </select>
                                            <label for="ISOStatut" class="form-label">Statut ISO</label>
                                        </div>
                                    <!--Date d'entretien-->
                                    <div class="form-floating mb-3">
                                        <input id="Date_Entretien" type="date" maxlength="100" class="form-control shadow-sm" placeholder="10/02/2023" name="Date_Entretien">
                                        <label for="Date_Entretien" class="form-label">Date d'entretien</label>
                                    </div>

                                    <!--Frais payés-->
                                    <div class="mx-3 d-flex justify-content-center">
                                        <label for="FraisPaye" class="form-check-label">Frais payés</label>
                                        <input id="FraisPaye" type="checkbox" maxlength="100" class="form-check-input ms-2" name="FraisPaye">
                                    </div>
                                </fieldset>
                            </div>
                            <div class="tab-pane fade show mt-3" id="notes-tab-pane" role="tabpanel" aria-labelledby="modifier_notes" tabindex="0">
                                <fieldset>
                                     <!--Anglais 1-->
                                    <div class="form-floating mb-3 input-group">
                                        <input id="Str_Anglais1" type="text" maxlength="100" class="form-control shadow-sm" placeholder="20" name="Str_Anglais1">
                                        <label for="Str_Anglais1" class="form-label">Anglais 1</label>
                                        <div class="input-group-text">/20</div>
                                    </div>
                                    <!--Anglais 2-->
                                    <div class="form-floating mb-3 input-group">
                                        <input id="Str_Anglais2" type="text" maxlength="100" class="form-control shadow-sm" placeholder="19" name="Str_Anglais2">
                                        <label for="Str_Anglais2" class="form-label">Anglais 2</label>
                                        <div class="input-group-text">/20</div>
                                    </div>
                                    <!--Note écrit-->
                                    <div class="form-floating mb-3 input-group">
                                        <input id="NoteEcrit" type="text" maxlength="100" class="form-control shadow-sm" placeholder="20" name="NoteEcrit">
                                        <label for="NoteEcrit" class="form-label">Écrit</label>
                                        <div class="input-group-text">/20</div>
                                    </div>
                                    <!--Note oral-->
                                    <div class="form-floating mb-3 input-group">
                                        <input id="NoteOral" type="text" maxlength="100" class="form-control shadow-sm" placeholder="20" name="NoteOral">
                                        <label for="NoteOral" class="form-label">Oral</label>
                                        <div class="input-group-text">/20</div>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="tab-pane fade  show mt-3" id="coordonnees-tab-pane" role="tabpanel" aria-labelledby="modifier_candidat" tabindex="0">
                                <fieldset>
                                    <!--Adresse 1-->
                                    <div class="form-floating mb-3">
                                        <input id="Adresse1" type="text" maxlength="100" class="form-control shadow-sm" placeholder="3 rue des peupliers" name="Adresse1">
                                        <label for="Adresse1" class="form-label">Adresse 1</label>
                                    </div>
                                    <!--Adresse 2-->
                                    <div class="form-floating mb-3">
                                        <input id="Adresse2" type="text" maxlength="100" class="form-control shadow-sm" placeholder="18 avenue montaigne" name="Adresse2">
                                        <label for="Adresse2" class="form-label">Adresse 2</label>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <!--Ville-->
                                            <div class="form-floating mb-3">
                                                <input id="Ville" type="text" maxlength="100" class="form-control shadow-sm" placeholder="Paris" name="Ville">
                                                <label for="Ville" class="form-label">Ville</label>
                                            </div>
                                        </div>
                                        <div class="col-md-5">
                                            <!--Code postal-->
                                            <div class="form-floating mb-3">
                                                <input id="CodePostal" type="text" maxlength="100" class="form-control shadow-sm" placeholder="75010" name="CodePostal">
                                                <label for="CodePostal" class="form-label">Code postal</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!--Pays-->
                                    <div class="form-floating mb-3">
                                        <input id="Pays" type="text" maxlength="100" class="form-control shadow-sm" placeholder="France" name="Pays">
                                        <label for="Pays" class="form-label">Pays</label>
                                    </div>
                                </fieldset>
                            </div>

                            <!--Evenements-->
                            <div class="tab-pane fade show mt-4" id="evenements-tab-pane" role="tabpanel" aria-labelledby="voir_evenements" tabindex="0">
                                <table class="table table-bordered p-3 shadow-sm" id="tableau_evenements">
                                    <thead>
                                        <tr class="text-center">
                                            <th scope="col" class="fs-6">ID</th>
                                            <th scope="col" class="fs-6">Date</th>
                                            <th scope="col" class="fs-6">Statut</th>
                                            <th scope="col" class="fs-6">Detail</th>
                                            <th scope="col" class="fs-6">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="event_table_body">
                                        <!--Contenu ajouté avec JQuery-->
                                    </tbody>
                                </table>
                                <div class="row  w-100">
                                    <div class="col">
                                        <a type="button" class="btn btn-outline-success fw-semibold" id="add_event" data-bs-toggle="modal" data-bs-target="#ModifierEvenement">
                                            <i class="fas fa-plus"></i>
                                            &nbsp;Ajouter
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row justify-content-between w-100">
                        <!-- Bouton temporairement masqué réservé pour un usage futur -->
                        <div class="col w-25 nav nav-pills">
                            <a type="button" class="text-secondary text-decoration-line-through" id="#" data-bs-toggle="tab" data-bs-target="#evenements-tab-pane" disabled hidden>
                                Futur bouton
                            </a>
                        </div>
                        <div class="container w-25 justify-content-end d-flex flex-row">
                                <button type="button" class="btn btn-secondary shadow me-3" data-bs-dismiss="modal">Annuler</button>
                                <button type="button" class="btn btn-bm shadow" id="save" data-bs-dismiss="modal">Modifier</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale Suppression Candidat-->
    <div class="modal fade" id="ModalDelete" tabindex="-1" aria-labelledby="ModalLabelDelete" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalLabelDelete">Suppression de l'élément</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="form_delete">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-bm" id="delete" data-bs-dismiss="modal">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale edition événement -->
    <div class="modal fade" id="ModifierEvenement" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModifierEvenementTitre"></h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="ModifierEvenementBody">
                    <form>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="event_id" placeholder="1" disabled>
                            <label for="event_id">ID</label>
                        </div> 
                        <div class="form-floating mb-3">
                            <input type="date" class="form-control" id="event_date" placeholder="16/04/2001" >
                            <label for="event_date">Date</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="event_statut">
                                <option selected>Choisir une option...</option>
                                <option value="prospect">prospect</option>
                                <option value="PROSPECT">PROSPECT</option>
                                <option value="CANDIDAT">CANDIDAT</option>
                            </select>
                            <label for="event_statut">Statut</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="event_detail" placeholder="(vide)" >
                            <label for="event_detail">Detail</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="container w-25 justify-content-end d-flex flex-row">
                            <button type="button" class="btn btn-secondary shadow me-3" data-bs-dismiss="modal">Annuler</button>
                            <button type="button" class="btn btn-bm shadow" id="saveEvent" data-bs-dismiss="modal">Modifier</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modale Suppression Événement-->
    <div class="modal fade" id="SupprimerEvenement" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="EventLabelDelete">Suppression de l'événement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="SupprimerEvenementBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-bm" id="deleteEvent" data-bs-dismiss="modal">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jszip-2.5.0/dt-1.12.1/b-2.2.3/b-colvis-2.2.3/b-html5-2.2.3/b-print-2.2.3/date-1.1.2/sl-1.4.0/datatables.min.js"></script>
    <!-- Table-to-json -->
    <script src="https://cdn.jsdelivr.net/npm/table-to-json@1.0.0/lib/jquery.tabletojson.min.js"
        integrity="sha256-H8xrCe0tZFi/C2CgxkmiGksqVaxhW0PFcUKZJZo1yNU=" crossorigin="anonymous"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
    <!-- Ellipsis.js -->
    <script src="https://cdn.datatables.net/plug-ins/1.12.1/dataRender/ellipsis.js"></script>

    <script>

        $(function () {
            var donnees4d ;
            var etiquettes ;
            var id_edit = 0;
            var table;
            var row = 0;
            var id_delete = 0;
            // <thead><tr id="entete">...
            var entetes = document.getElementById("entete");
            var formEdit = document.getElementById("form_edit");
            var formDelete = document.getElementById("form_delete");

            loadListe('http://40.118.109.120:8083/_candidats');

            function loadListe(url) {
                var xhttp = new XMLHttpRequest();
                // Définit la fonction invoquée a chaque changement d'état
                xhttp.onreadystatechange = function () {
                    // XMLHttpRequest.readyState = 4 <=> réponse prête
                    // XMLHttpRequest.status = 200 <=> statut HTTP
                    if (this.readyState == 4 && this.status == 200) {
                        // données4D = XMLHttpRequest.responseText : la réponse du serveur sous forme d'une string parsée sous forme d'un objet javascript
                        donnees4d = JSON.parse(xhttp.responseText);
                        // Les clés des propriétés de l'objet
                        etiquettes = Object.keys(donnees4d[Object.keys(donnees4d)][0]);
                        afficherEntetes(etiquettes);
                        afficherDonnees();
                    }
                };
                // XMLHttpRequest.open("méthodeHTTP" : string, "urlCible" : string, isAsynchrone : boolean);
                xhttp.open("GET", url, true);
                // Ajout de la clé d'api dans l'en-tête
                xhttp.setRequestHeader('key', "token");
                xhttp.setRequestHeader('value', "xbq12048=!");
                xhttp.setRequestHeader('type', "default");
                xhttp.send();
            }

            // etiquettes est un tableau contenant les clés des propriétés du json renvoyé par le serveur
            function afficherEntetes(etiquettes) {
                // Vide le contenu html des entetes du tableau et du corps de la modale
                entetes.innerHTML = "";
                // NE PAS VIDER LE CONTENU DE LA MODALE 
                //formEdit.innerHTML = "";
                // Traverse le tableau etiquettes
                etiquettes.forEach(element => {
                    // crée une colonne dans le tableau pour chaque propriété de l'objet candidat
                    entetes.innerHTML += "<th>" + element + "</th>";
                    // Masque l'affichage de la colonne contenant l'ID
                    var display = "";
                    if (element == 'id') {
                        display = " hidden"
                    }
                    // NE PAS CRÉER LE FORMULAIRE
                    // Crée un champ de formulaire pour chaque propriété de candidat
                    //formEdit.innerHTML += "<label" + display + " class='mt-3'>" + element + "</label>"
                    // Si l'élément est un booléen le champ sera une checkbox
                    //if (donnees4d[Object.keys(donnees4d)][0][element] == "Vrai" | donnees4d[Object.keys(donnees4d)][0][element] == "Faux") {
                    //    formEdit.innerHTML += "<input " + display + " type='checkbox' class='form-check-input ms-3 mt-3' name=" + element + " id=" + element + " value=''><br>"
                    // Sinon ce sera un champ textuel
                    //} else {
                    //    formEdit.innerHTML += "<input" + display + " type='text' class='form-control shadow-sm' name=" + element + " id=" + element + " value=''>"
                    //}
                });
                // Ajout d'une colonne vide qui contiendra les boutons modifier et supprimer
                entetes.innerHTML += "<th></th>";
            }
            

            function afficherDonnees() {
                var TableauDonnees = [];
                etiquettes.forEach(element => {
                    // N'affiche pas les ID
                    if (element == "id") {
                        TableauDonnees.push({ "data": element, "visible": false });
                    } else {
                        // Si il existe un champ date l'afficher
                        if (element.indexOf("Date") > -1) {
                            TableauDonnees.push({
                                "data": element, "render": DataTable.render.datetime('DD/MM/YYYY','Do MMMM YY')
                            });
                        } else {
                            TableauDonnees.push({ "data": element });
                        }
                    }
                });

                TableauDonnees.push({
                    defaultContent: '<button type="button" class="btn btn-dt-bm mx-2 edit" data-bs-toggle="modal" data-bs-target="#Modal" ><i class="fas fa-edit"></i></button><button type="button" class="btn btn-dt-rm mx-2 delete" $displayDelete$ data-bs-toggle="modal" data-bs-target="#ModalDelete" ><i class="fas fa-trash"></i></button>'
                });
                table = $('#maTable').DataTable({
                    responsive: true,
                    searching: true,
                    dom: 'Bfrtip',
                    buttons: [],
                    scrollY: true,
                    scrollX: true,
                    scrollCollapse: true,
                    paging: true,
                    pageLength: 50,
                    lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                    fixedColumns: false,
                    language: {
                        processing: "Traitement en cours...",
                        search: "Rechercher&nbsp;:",
                        lengthMenu: "Afficher _MENU_ &eacute;l&eacute;ments",
                        info: "Affichage de _START_ &agrave; _END_ sur _TOTAL_ ",
                        infoEmpty: "Aucun &eacute;l&eacute;ment",
                        infoFiltered: "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
                        infoPostFix: "",
                        loadingRecords: "Chargement en cours...",
                        zeroRecords: "Aucun &eacute;l&eacute;ment",
                        emptyTable: "Aucune donnée disponible dans le tableau",
                        paginate: {
                            first: "Premier",
                            previous: "Pr&eacute;c&eacute;dent",
                            next: "Suivant",
                            last: "Dernier"
                        },
                        aria: {
                            sortAscending: ": activer pour trier la colonne par ordre croissant",
                            sortDescending: ": activer pour trier la colonne par ordre décroissant"
                        }
                    },
                    data: donnees4d[Object.keys(donnees4d)],
                    order: [[0, "asc"]],
                    columns:
                        TableauDonnees,
                    columnDefs: [
                        { targets: -1, width: '50px' },
                        {
                            targets: '_all', "render": function (data, type, full) {
                                if (data === "Vrai") {
                                    return '<i class="far fa-check-square"></i>';
                                } else {
                                    if (data === "Faux") {
                                        return '<i class="far fa-square"></i>';
                                    } else {
                                        return data;
                                    }
                                }
                            }
                        }]
                });
            }

            $('#maTable').on('click', 'td .delete', function () {
                row = $(this).closest('tr');
                id_delete = table.row(row).data().id;
                formDelete.innerHTML = "Attention, la suppression de l'élément " + id_delete + " est définitive !"
            });

            $('#delete').on('click', function () {
                var request = new XMLHttpRequest();
                request.open('DELETE', '/$url$/' + id_delete);
                request.setRequestHeader('Content-Type', 'application/json');
                request.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        location.reload();
                    }
                };
                request.send();
            });

            $("input[type=checkbox]").on('change', function () {
                if ($(this).is(':checked')) {
                    $(this).val('true');
                } else {
                    $(this).val('false');
                }
            });

            $("input[type=radio]").on('change', function () {
                if ($(this).is(':checked')) {
                    $(this).val('true');
                } else {
                    $(this).val('false');
                }
            });

            function dateFormat(dateStr) {
                dateArray = dateStr.split("/");
                return dateArray[2] + "-" + dateArray[1] + "-" + dateArray[0];
            }

            // Initialisation des datepickers
            $.datepicker.setDefaults( $.datepicker.regional[ "fr" ] );


            var dateFormat = "dd/mm/yy",
            date = $( "#idDateNaissance" ).datepicker({
                changeMonth: true,
                changeYear: true,
                yearRange: "-30:+0",
            });

            // Prend une string au format "dd/mm/yyyy" en entrée et renvoie un objet date
            function getDate(date_string) {
                var date;
                try {
                    date = $.datepicker.parseDate( dateFormat, date_string);
                } catch( error ) {
                    date = null;
                    console.error("fonction getDate() : " + error);
                }
                return date;
            }

            // Fonction de test de validation de dates
            function isDate(d) {
                // Cette fonction permet de vérifier la validité d'une date au format jj/mm/aa ou jj/mm/aaaa
    
                if (d == "") // si la variable est vide on retourne faux
                    return false;
    
                e = new RegExp("^[0-9]{1,2}\/[0-9]{1,2}\/([0-9]{2}|[0-9]{4})$");
    
                if (!e.test(d)) // On teste l'expression régulière pour valider la forme de la date
                    return false; // Si pas bon, retourne faux

                // On sépare la date en 3 variables pour vérification, parseInt() converti du texte en entier
                j = parseInt(d.split("/")[0], 10); // jour
                m = parseInt(d.split("/")[1], 10); // mois
                a = parseInt(d.split("/")[2], 10); // année

                // Si l'année n'est composée que de 2 chiffres on complète automatiquement
                if (a < 1000) {
                    if (a < 89)	a+=2000; // Si a < 89 alors on ajoute 2000 sinon on ajoute 1900
                    else a+=1900;
                }

                // Définition du dernier jour de février
                // Année bissextile si année divisible par 4 et que ce n'est pas un siècle, ou bien si divisible par 400
                if (a%4 == 0 && a%100 !=0 || a%400 == 0) fev = 29;
                else fev = 28;

                // Nombre de jours pour chaque mois
                nbJours = new Array(31,fev,31,30,31,30,31,31,30,31,30,31);

                // Enfin, retourne vrai si le jour est bien entre 1 et le bon nombre de jours, idem pour les mois, sinon retourn faux
                return ( m >= 1 && m <=12 && j >= 1 && j <= nbJours[m-1] );
            }

            /*
                Affichage de la modale permettant d'éditer un candidat
            */

            $('#maTable').on('click', 'td .edit', function () {

                $('#save').html('Modifier');
                $('#ModalLabel').html("Modification de l'élément");

                var row = $(this).closest('tr');
                let idCandidat = table.row(row).data().id;

                getEvenementsCandidat(idCandidat);

                etiquettes.forEach(element => {

                    $('#' + element).val(table.row(row).data()[element]);
                    
                    if (table.row(row).data()[element] == "Vrai") {
                        $('#' + element).prop("checked", true);
                    } else {
                        $('#' + element).prop("checked", false);
                    }
                    
                    if ( $('#' + element).attr("type") == "date" ) {
                        //Stocke la date sous forme de string "jj/mm/aaaa" si c'est bien une date
                        let date_string = isDate( table.row(row).data()[element] ) ? (table.row(row).data()[element]) : null;
                        // Parse date_string en objet date et formate cet objet en chaine ISO_8601
                        let date_iso = (date_string) ? $.datepicker.formatDate('yy-mm-dd', getDate(date_string) ) : null ;
                        // Remplit le champ date avec la valeur au format ISO_8601
                        $("#" + element).val(date_iso);  
                    }

                });

            });

            /*
            *   Vide le contenu de la modale de candidat pour permettre l'ajout
            */

            $('#ajouter').on('click', function () {
                $("#event_table_body").empty();
                $('#save').html('Ajouter');
                $('#ModalLabel').html("Ajout d'un élément");
                etiquettes.forEach(element => {
                    $('#' + element).val("");
                    $('#' + element).prop("checked", false);
                });
            })

            $('#save').on('click', function () {
                formatJson();
                var request = new XMLHttpRequest();
                if ($('#save').html() == "Modifier") {
                    request.open('PUT', '/$url$/' + id_edit);
                } else {
                    request.open('POST', '/$url$/');
                }
                request.setRequestHeader('Content-Type', 'application/json');
                request.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        location.reload();
                    }
                };
                request.send(JSON.stringify(obj));
            })

            //formattage en json 
            var obj = {};
            function formatJson() {
                obj = {};
                $('input,textarea').each(function () {
                    if ($(this).prop('type') != 'button' && $(this).prop('type') != 'search') {
                        nomProp = $(this).attr('name');
                        obj[nomProp] = $(this).val();

                    }
                });
            }

            /*
                Coloration de l'onglet actif dans la modale 
            */

            $(".nav-link").on("click", function () {
                    
                $(".nav-link").addClass("text-secondary");
                $(".nav-link").removeClass("text-primary");
                $("#voir_evenements").removeClass("active");
                    
                $(this).addClass("text-primary");
                $(this).removeClass("text-secondary");

                if ( $(this).attr("id") == "voir_evenements") {
                    $("a.nav-link").removeClass("active");
                }
            })

            /*
                Récupération des événements du candidat
            */

            function getEvenementsCandidat(id) {

                let requete = new XMLHttpRequest();
                const url = "http://40.118.109.120:8083/_candidats/" + id;
                var evenements; // Array d'événements
                
                requete.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        let donneesCandidat = JSON.parse(requete.responseText);
                        evenements = JSON.parse(donneesCandidat[0].Evenements);
                        remplirTableauEvenements(evenements);
                    }
                };
 
                requete.open("get", url, true);
                requete.setRequestHeader('key', "token");
                requete.setRequestHeader('value', "xbq12048=!");
                requete.setRequestHeader('type', "default");
                requete.send();
                                 
            }

            /* 
                Remplissage d'un tableau html avec la liste des événements d'un candidat
            */

            function remplirTableauEvenements(evenements) {

                $("#event_table_body").empty();

                evenements.forEach(objet => {

                    $("#event_table_body").append("<tr class=\"text-center\" id=\"" + objet.id + "\">");  

                    for(propriete in objet) {

                        let valeur = objet[propriete];

                        if (propriete === "date") {
                            valeur = $.datepicker.formatDate("dd/mm/yy", new Date(valeur)) ;
                        }

                        if (propriete === "detail" && !valeur) {
                           console.log("Details vide détecté");
                           valeur = "(vide)";
                        }

                        $("#" + objet.id).append(`<td class=\"fs-6\" id=\"tableau_event_${propriete}\">${valeur}</td>`);

                    }

                    $("#" + objet.id ).append("<td class=\"justify-content-between\" id=\"tableau_event_action\"><button type=\"button\" class=\"btn btn-dt-bm\" id=\"edit_event_btn\" data-bs-toggle=\"modal\" data-bs-target=\"#ModifierEvenement\"><i class=\"fas fa-edit \"></i></button><button type=\"button\" class=\"btn btn-dt-rm\" id=\"delete_event_btn\" data-bs-toggle=\"modal\" data-bs-target=\"#SupprimerEvenement\"> <i class=\"fas fa-trash \"></i></button></td>");
                });
            }

            /* 
                Remplit le formulaire de modification des événements avec les valeurs actuelles du tableau
            */

            $("#evenements-tab-pane").on("click", "td #edit_event_btn", function() {

                $("#Modal").toggleClass("show")

                let currentRow = $(this).closest("tr"); 

                let id = currentRow.children("#tableau_event_id").html();
                let date_string= currentRow.children("#tableau_event_date").html();
                // Parse date_string en objet date et formate cet objet en chaine ISO_8601
                let date_iso = (date_string) ? $.datepicker.formatDate('yy-mm-dd', getDate(date_string) ) : null ;
                let statut = currentRow.children("#tableau_event_statut").html();
                let detail = currentRow.children("#tableau_event_detail").html();

                $('#ModifierEvenementTitre').html("Modifier événement n° " + id);

                $("#event_id").val(id);
                $("#event_date").val(date_iso);
                $("#event_statut").val(statut);
                $("#event_detail").val(detail);
 
            });

            /* 
                Rétablit l'affichage de la modale du candidat lorsqu'on quitte l'édition d'un événement 
            */

            $("#ModifierEvenement").on("click", "button", () => $("#Modal").toggleClass("show"));
            $("#SupprimerEvenement").on("click", "button", () => $("#Modal").toggleClass("show"));

            /*
                Envoie les modification apportées à l'événement à l'API
            */

            $('#saveEvent').on('click', function () {

                const url = "http://40.118.109.120:8083/devpost";

                // ID de l'événement en cas de besoin futur
                let eventID = $("#ModifierEvenementBody").find("#event_id").val();

                let candidat = getCandidatObject();
                add_event_form_content(candidat);
               

                var requete = new XMLHttpRequest();

                if ($('#saveEvent').html() == "Modifier") {
                    requete.open('PUT', url + "/" + eventID); // Ajouter un point d'entrée correct de l'API
                } else {
                    console.log("Event POST request opened !");
                    requete.open('POST', url); // Ajouter une point d'entrée correct de l'API
                }

                // Headers
                requete.setRequestHeader('key', "token");
                requete.setRequestHeader('value', "xbq12048=!");
                requete.setRequestHeader('type', "default");
                requete.setRequestHeader('Content-Type', 'application/json');

                requete.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        //location.reload();
                    }
                };

                requete.send(JSON.stringify(candidat));

            });

            function getCandidatObject() {

                // On définit au préalable les propriétés de l'objet 
                let candidat = {
                    id: "",
                    Prenom: "",
                    email: "",
                    Nom: "",
                    datenaissance: "",
                    CentreNom: "",
                    FormationSouhaitee: "",
                    ISOStatut: "",
                    Date_Entretien: "",
                    NDossier: "",
                    Str_Anglais1: "",
                    Str_Anglais2: "",
                    FraisPaye: false,
                    NoteEcrit: "",
                    NoteOral: "",
                    Sexe: "",
                    Adresse1: "",
                    Adresse2: "",
                    CodePostal: "",
                    Ville: "",
                    Pays: "",
                    Creation: "",
                    Evenements: [], 
                    Photo: "" 
                };

                // On remplit les propriétés du candidat avec les valeurs des champs du formulaire
                $('input,textarea,select').each(function () {
                    // Si ce champ n'est pas un bouton ou une barre de recherche
                    if ($(this).prop('type') != 'button' && $(this).prop('type') != 'search') {
     
                        nomProp = $(this).attr('name');
                        // Uniquement si le champ correspond bien a une propriété de candidat
                        if ( nomProp in candidat) {
                            candidat[nomProp] = $(this).val();
                        }
                    }
                });

                return add_event_table_content(candidat);
            }

            /*
            *   Récupére les valeurs du formulaire événement et ajoute cet événement à l'objet candidat passé
            */
            function add_event_form_content(candidat) {
                // On définit au préalable les propriétés d'un événement
                let evenement = {id:null,date:null,statut:null,detail:null};

                
                $("#ModifierEvenementBody").find("input,select").each(function() {
                    // Récupére l'ID du champ du formulaire
                    let id = $(this).attr('id');
                    // Récupére la fin de l'id "event_****" qui correspond au nom de la propriété à ajouter dans l'événement
                    id = id.split("_", 2)[1];
                    // Remplit la propriété de l'évenement avec la valeur correspondante dans le formulaire
                    evenement[id] = $(this).val()
                });
                                
                // Ajouter directement l'événement si l'array Evenements est vide
                if (!(candidat.Evenements.length)) {
                    candidat.Evenements.push(evenement);
                } else {
                    // Sinon vérifier qu'il n'existe pas une autre version de l'événement
                    let evenement_en_double = false;
                    for(autreEvenement in candidat.Evenements) {
                        // Écraser l'ancienne version de l'événement si elle existe
                        if ( candidat.Evenements[autreEvenement].id == evenement.id) {
                            console.log("ID d'événements similaires détectés");
                            candidat.Evenements[autreEvenement] = evenement;
                            evenement_en_double = true;
                        }
                    }
                    if (!evenement_en_double) {
                        candidat.Evenements.push(evenement);
                   }
                }

                return candidat;
            }

            function add_event_table_content(candidat) {

                $("#event_table_body").children("tr").each( function() {
                    // Déclare un nouvel evenement vierge 
                    let evenement = {id:null,date:null,statut:null,detail:null};
                    // Initialise son ID
                    evenement.id = $(this).attr("id");
                    // Remplit les autres propriétés avec le contenu des colonnes
                    $(this).children('td').each( function() {
                        
                        let nom_colonne = $(this).attr('id');
                        nom_colonne = nom_colonne.split("_",3)[2];
                        if( nom_colonne !== "action") {
                            evenement[nom_colonne] = $(this).html()
                        }
                    });
                    // Ajoute l'évenement au candidat
                    candidat.Evenements.push(evenement);
                });

                return candidat;
            }

            
            /*
            *    Affichage de la modale de suppression d'un événement
            */

            $('#evenements-tab-pane').on('click', 'td #delete_event_btn', function () {

                $("#Modal").toggleClass("show");
                let contenu =  document.getElementById("SupprimerEvenementBody");

                id_delete = $(this).closest("tr").children("#tableau_event_id").html();
                contenu.innerHTML = "Attention, la suppression de l'événement " + id_delete + " est définitive !"
            });

            /*
            *   Envoi d'une requête de suppression d'un événement
            */

            $('#deleteEvent').on('click', function () {
                var request = new XMLHttpRequest();
                request.open('DELETE', '/$url$/' + id_delete);
                request.setRequestHeader('Content-Type', 'application/json');
                request.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        location.reload();
                    }
                };
                request.send();
            });

            /*
            *   Nettoyage de la modale de modification des événements pour l'ajout
            */

             $('#add_event').on('click', function () {
                $("#Modal").toggleClass("show");
                $("#ModifierEvenementBody").find(".form-control").val("");
                $("#ModifierEvenementBody").find(".form-select").val("");
                $('#saveEvent').html('Ajouter');
                $('#ModifierEvenementTitre').html("Ajout d'un événement");
                $("#event_id").val("null");
            });


       });
    </script>

    </body>

    </html>